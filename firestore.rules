rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to any document under the /public path. Write access is denied.
     * @path /public/{document=**}
     * @allow (get, list) Any user can read data in this collection.
     * @deny (create, update, delete) No user can write data to this collection.
     * @principle Grants public read access for general game information.
     */
    match /public/{document=**} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to any document under the /config path. Write access is denied.
     * @path /config/{document=**}
     * @allow (get, list) Any user can read data in this collection.
     * @deny (create, update, delete) No user can write data to this collection.
     * @principle Grants public read access for configuration settings.
     */
    match /config/{document=**} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for the /users/{userId} document. Only the authenticated user can read or write their own document.
     * @path /users/{userId}
     * @allow (get, create, update, delete) User with ID 'user123' can read/write their own profile.
     * @deny (get, create, update, delete) User with ID 'user456' cannot access 'user123' profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // prevent listing of all users
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);

      /**
       * @description Enforces user-ownership for characters under /users/{userId}/characters/{charId}.
       * @path /users/{userId}/characters/{charId}
       * @allow (get, create, update, delete) User 'user123' can manage their character 'char789'.
       * @deny (get, create, update, delete) User 'user456' cannot access 'user123' character 'char789'.
       * @principle Enforces ownership for character data.
       */
      match /characters/{charId} {
        allow get: if isSignedIn() && isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);

        /**
         * @description Enforces user-ownership for inventory items under /users/{userId}/characters/{charId}/inventory/{itemId}.
         * @path /users/{userId}/characters/{charId}/inventory/{itemId}
         * @allow (get, create, update, delete) User 'user123' can manage item 'item456' in character 'char789' inventory.
         * @deny (get, create, update, delete) User 'user456' cannot access 'user123' item 'item456'.
         * @principle Enforces ownership for inventory items.
         */
        match /inventory/{itemId} {
          allow get: if isSignedIn() && isOwner(userId);
          allow list: if false;
          allow create: if isSignedIn() && isOwner(userId);
          allow update: if isSignedIn() && isOwner(userId);
          allow delete: if isSignedIn() && isOwner(userId);
        }

        /**
         * @description Enforces user-ownership for stats under /users/{userId}/characters/{charId}/stats/{statId}.
         * @path /users/{userId}/characters/{charId}/stats/{statId}
         * @allow (read, write) User 'user123' can manage stat 'stat123' for their character 'char789'.
         * @deny (read, write) User 'user456' cannot access 'stat123' of 'user123'.
         */
        match /stats/{statId} {
          allow get: if isSignedIn() && isOwner(userId);
          allow list: if false;
          allow create: if isSignedIn() && isOwner(userId);
          allow update: if isSignedIn() && isOwner(userId);
          allow delete: if isSignedIn() && isOwner(userId);
        }

        /**
         * @description Enforces user-ownership for equipment under /users/{userId}/characters/{charId}/equipment/{equipId}.
         * @path /users/{userId}/characters/{charId}/equipment/{equipId}
         * @allow (read, write) User 'user123' can manage equipment 'equip123' for their character 'char789'.
         * @deny (read, write) User 'user456' cannot access 'equip123' of 'user123'.
         */
        match /equipment/{equipId} {
          allow get: if isSignedIn() && isOwner(userId);
          allow list: if false;
          allow create: if isSignedIn() && isOwner(userId);
          allow update: if isSignedIn() && isOwner(userId);
          allow delete: if isSignedIn() && isOwner(userId);
        }
      }
    }
  }

  // Helper Functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }
}