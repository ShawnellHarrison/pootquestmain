/**
 * @fileoverview Firestore Security Rules for Poot Quest.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data,
 * while allowing public read access to certain global collections like 'products' and 'cards'.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}, including characters, decks, narrative contexts, and run chronicles.
 * - Global data (cards, products) resides in top-level collections.
 *
 * Key Security Decisions:
 * - Users can only access their own data under their respective /users/{userId} path.
 * - Public read access is granted for /products and /cards collections to allow unauthenticated clients to fetch product catalogs and card lists.
 * - Write access to /cards is not granted in this prototyping phase.
 * - List access is only permitted on collections intended for listing by the client.
 *
 * Denormalization for Authorization:
 * The data structure is designed to avoid the need for `get()` calls in security rules.
 * User ownership is enforced using path-based rules (e.g., /users/{userId}/...) and explicit ownership fields within documents (e.g., `userId` in RunChronicle).
 * This allows for fast, simple rules like `isOwner(userId)` without extra reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request.auth.uid matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Combines ownership check with existence check.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with auth UID 'user_abc' can create a document at /users/user_abc.
     * @deny (create) User with auth UID 'user_xyz' cannot create a document at /users/user_abc.
     * @principle Enforces document ownership; only the authenticated user can create their own user document.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/characters/{characterId} collection.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) User with auth UID 'user_abc' can create a character at /users/user_abc/characters/char_123.
     * @deny (create) User with auth UID 'user_xyz' cannot create a character at /users/user_abc/characters/char_123.
     * @principle Enforces document ownership; only the authenticated user can create characters under their user document.
     */
    match /users/{userId}/characters/{characterId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/characters/{characterId}/decks/{deckId} collection.
     * @path /users/{userId}/characters/{characterId}/decks/{deckId}
     * @allow (create) User with auth UID 'user_abc' can create a deck at /users/user_abc/characters/char_123/decks/deck_main.
     * @deny (create) User with auth UID 'user_xyz' cannot create a deck at /users/user_abc/characters/char_123/decks/deck_main.
     * @principle Enforces document ownership; only the authenticated user can create decks under their character document.
     */
    match /users/{userId}/characters/{characterId}/decks/{deckId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.characterId == characterId;
      allow update: if isExistingOwner(userId) && request.resource.data.characterId == resource.data.characterId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/characters/{characterId}/inventory/{itemId} collection.
     * @path /users/{userId}/characters/{characterId}/inventory/{itemId}
     */
    match /users/{userId}/characters/{characterId}/inventory/{itemId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/characters/{characterId}/narrativeContexts/{narrativeContextId} collection.
     * @path /users/{userId}/characters/{characterId}/narrativeContexts/{narrativeContextId}
     * @allow (create) User with auth UID 'user_abc' can create a narrative context at /users/user_abc/characters/char_123/narrativeContexts/narr_main.
     * @deny (create) User with auth UID 'user_xyz' cannot create a narrative context at /users/user_abc/characters/char_123/narrativeContexts/narr_main.
     * @principle Enforces document ownership; only the authenticated user can create narrative contexts under their character document.
     */
    match /users/{userId}/characters/{characterId}/narrativeContexts/{narrativeContextId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.characterId == characterId;
      allow update: if isExistingOwner(userId) && request.resource.data.characterId == resource.data.characterId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/runChronicles/{runChronicleId} collection.
     * @path /users/{userId}/runChronicles/{runChronicleId}
     * @allow (create) User with auth UID 'user_abc' can create a run chronicle at /users/user_abc/runChronicles/run_123.
     * @deny (create) User with auth UID 'user_xyz' cannot create a run chronicle at /users/user_abc/runChronicles/run_123.
     * @principle Enforces document ownership; only the authenticated user can create run chronicles under their user document.
     */
    match /users/{userId}/runChronicles/{runChronicleId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /cards/{cardId} collection.
     * @path /cards/{cardId}
     * @allow (get) Any user can get a card.
     * @allow (list) Any user can list cards.
     * @deny (create) No user can create a card.
     * @principle Public read, admin-only write.
     */
    match /cards/{cardId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin-only write rule once roles are defined
      allow update: if false; // TODO: Add admin-only write rule once roles are defined
      allow delete: if false; // TODO: Add admin-only write rule once roles are defined
    }

    /**
     * @description Rule for the /products/{productId} collection.
     * @path /products/{productId}
     * @allow (get) Any user can get a product.
     * @allow (list) Any user can list products.
     * @deny (create) No user can create a product.
     * @principle Public read, owner-only write.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin-only write rule once roles are defined
      allow update: if false; // TODO: Add admin-only write rule once roles are defined
      allow delete: if false; // TODO: Add admin-only write rule once roles are defined
    }
  }
}