
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Poot Quest game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "User's display name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "creationDate": {
          "type": "string",
          "description": "Date and time the user account was created.",
          "format": "date-time"
        },
        "lastLogin": {
          "type": "string",
          "description": "Date and time of the user's last login.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "username",
        "email",
        "creationDate"
      ]
    },
    "Character": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Character",
      "type": "object",
      "description": "Represents a playable character in the Poot Quest game.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Character)"
        },
        "class": {
          "type": "string",
          "description": "The character's class (e.g., Rogue, Paladin)."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the character's portrait image."
        },
        "level": {
          "type": "number",
          "description": "The character's current level."
        },
        "experience": {
          "type": "number",
          "description": "The character's current experience points."
        },
        "health": {
          "type": "number",
          "description": "The character's current health points."
        },
        "maxHealth": {
          "type": "number",
          "description": "The character's maximum health points."
        },
        "mana": {
          "type": "number",
          "description": "The character's current mana points."
        },
        "maxMana": {
          "type": "number",
          "description": "The character's maximum mana points."
        },
        "attack": {
          "type": "number",
          "description": "The character's attack power."
        },
        "defense": {
          "type": "number",
          "description": "The character's defense."
        },
        "speed": {
          "type": "number",
          "description": "The character's speed."
        },
        "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp of when the character was created."
        }
      },
      "required": [
        "userId",
        "class",
        "level",
        "experience",
        "health",
        "maxHealth",
        "mana",
        "maxMana",
        "createdAt"
      ]
    },
    "Item": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Item",
      "type": "object",
      "description": "Represents an item that a character can possess in their inventory.",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the item."
        },
        "description": {
          "type": "string",
          "description": "A description of the item."
        },
        "type": {
          "type": "string",
          "enum": ["weapon", "armor", "potion", "scroll", "misc"],
          "description": "The type of the item."
        }
      },
      "required": ["name", "description", "type"]
    },
    "Card": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Card",
      "type": "object",
      "description": "Represents a card in the Poot Quest game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the card."
        },
        "name": {
          "type": "string",
          "description": "The name of the card."
        },
        "description": {
          "type": "string",
          "description": "Description of what the card does."
        },
        "class": {
          "type": "string",
          "description": "The character class the card belongs to."
        },
        "manaCost": {
          "type": "number",
          "description": "The mana cost to play the card."
        },
        "attack": {
          "type": "number",
          "description": "The attack power of the card, if applicable."
        },
        "defense": {
          "type": "number",
          "description": "The defense value of the card, if applicable."
        },
        "healing": {
          "type": "number",
          "description": "The healing value of the card, if applicable."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "class",
        "manaCost"
      ]
    },
    "Deck": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Deck",
      "type": "object",
      "description": "Represents a deck of cards owned by a character.",
      "properties": {
        "characterId": {
          "type": "string",
          "description": "Reference to Character. (Relationship: Character 1:N Deck)"
        },
        "cards": {
          "type": "array",
          "description": "List of card names in the deck.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "characterId",
        "cards"
      ]
    },
    "Encounter": {
       "$schema": "http://json-schema.org/draft-07/schema#",
       "title": "Encounter",
       "type": "object",
       "description": "Stores the details for a specific combat encounter.",
       "properties": {
          "enemies": {
            "type": "array",
            "description": "List of enemies in the encounter.",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "hp": { "type": "number" },
                "maxHp": { "type": "number" },
                "imageUrl": { "type": "string" },
                "attack": { "type": "number" }
              },
              "required": ["id", "name", "hp", "maxHp", "imageUrl", "attack"]
            }
          },
          "loot": {
            "type": "object",
            "description": "Loot to be awarded upon winning the encounter.",
            "properties": {
                "name": { "type": "string" },
                "description": { "type": "string" },
                "type": { "type": "string", "enum": ["weapon", "armor", "potion", "scroll", "misc"] }
            },
            "required": ["name", "description", "type"]
          },
          "introText": {
            "type": "string",
            "description": "Introductory text for the encounter."
          }
       },
       "required": ["enemies", "loot", "introText"]
    },
    "NarrativeContext": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "NarrativeContext",
      "type": "object",
      "description": "Stores the narrative context of the game for AI-driven story generation.",
      "properties": {
        "characterId": {
          "type": "string",
          "description": "Reference to Character. (Relationship: Character 1:1 NarrativeContext)"
        },
        "location": {
          "type": "string",
          "description": "The current location of the character in the game world."
        },
        "storyArc": {
          "type": "string",
          "description": "The current story arc the character is following."
        },
        "lastNarration": {
          "type": "string",
          "description": "The last major narration text shown to the player."
        },
        "currentScenario": {
          "type": "object",
          "description": "The current AI-generated scenario, including text and choices.",
           "nullable": true
        },
        "currentEncounter": {
          "type": "object",
          "description": "The current AI-generated combat encounter.",
          "$ref": "#/entities/Encounter",
          "nullable": true
        },
        "triggerNextScenario": {
            "type": "boolean",
            "description": "A flag to signal that the next scenario should be generated after a battle."
        },
        "playerChoices": {
          "type": "array",
          "description": "An array of choices the player has made.",
          "items": {
            "type": "object"
          }
        },
        "reputationStealth": {
          "type": "number",
          "description": "Player's stealth reputation score."
        },
        "reputationCombat": {
          "type": "number",
          "description": "Player's combat reputation score."
        },
        "reputationDiplomacy": {
          "type": "number",
          "description": "Player's diplomacy reputation score."
        },
        "unlockedPaths": {
          "type": "array",
          "description": "Unlocked narrative paths",
          "items": {
            "type": "string"
          }
        },
        "questFlags": {
          "type": "object",
          "description": "Quest flags as a map, tracking status and step.",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": ["started", "completed", "failed"]
              },
              "currentStep": {
                "type": "number"
              }
            },
            "required": ["status", "currentStep"]
          }
        }
      },
      "required": [
        "characterId",
        "location",
        "storyArc"
      ]
    },
    "RunChronicle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RunChronicle",
      "type": "object",
      "description": "Represents a single run of the game, storing information for the chronicle system.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N RunChronicle)"
        },
        "characterClass": {
          "type": "string",
          "description": "The character class used during the run."
        },
        "moralAlignment": {
          "type": "string",
          "description": "The moral alignment of the character during the run."
        },
        "enemiesSpared": {
          "type": "number",
          "description": "The number of enemies spared during the run."
        },
        "enemiesKilled": {
          "type": "number",
          "description": "The number of enemies killed during the run."
        },
        "secretRoomsFound": {
          "type": "number",
          "description": "The number of secret rooms found during the run."
        },
        "ending": {
          "type": "string",
          "description": "The ending the player achieved during the run."
        },
        "uniqueDiscovery": {
          "type": "string",
          "description": "Any unique discoveries made during the run."
        }
      },
      "required": [
        "userId",
        "characterClass",
        "moralAlignment"
      ]
    }
  },
  "auth": {
    "providers": [
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/entities/User"
          },
          "description": "Stores user account information.  Path-based ownership ensures only the user can access their own document.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching their Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/characters/{characterId}",
        "definition": {
          "entityName": "Character",
          "schema": {
            "$ref": "#/entities/Character"
          },
          "description": "Stores character data owned by a specific user.  Path-based ownership ensures only the owning user can access the character data. Contains 'userId' for explicit ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the character."
            },
            {
              "name": "characterId",
              "description": "The unique identifier of the character."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/characters/{characterId}/decks/{deckId}",
        "definition": {
          "entityName": "Deck",
          "schema": {
            "$ref": "#/entities/Deck"
          },
          "description": "Stores decks of cards associated with a character. Path-based ownership ensures only the owning user can access the deck data. Contains 'characterId' to link to the parent character.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the character."
            },
            {
              "name": "characterId",
              "description": "The unique identifier of the character that owns the deck."
            },
            {
              "name": "deckId",
              "description": "The unique identifier of the deck. Should typically be 'main'."
            }
          ]
        }
      },
       {
        "path": "/users/{userId}/characters/{characterId}/inventory/{itemId}",
        "definition": {
          "entityName": "Item",
          "schema": {
            "$ref": "#/entities/Item"
          },
          "description": "Stores items in a character's inventory.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "characterId",
              "description": "The unique identifier of the character."
            },
            {
              "name": "itemId",
              "description": "The unique identifier of the item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/characters/{characterId}/narrativeContexts/{narrativeContextId}",
        "definition": {
          "entityName": "NarrativeContext",
          "schema": {
            "$ref": "#/entities/NarrativeContext"
          },
          "description": "Stores narrative context data for a character, used for AI-driven story generation. Path-based ownership ensures only the owning user can access this data. Contains 'characterId' to link to the parent character.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the character."
            },
            {
              "name": "characterId",
              "description": "The unique identifier of the character."
            },
            {
              "name": "narrativeContextId",
              "description": "The unique identifier of the narrative context. Should typically be 'main'."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/runChronicles/{runChronicleId}",
        "definition": {
          "entityName": "RunChronicle",
          "schema": {
            "$ref": "#/entities/RunChronicle"
          },
          "description": "Stores game run chronicles for a user. Path-based ownership ensures only the owning user can access their run history. Contains 'userId' for explicit ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "runChronicleId",
              "description": "The unique identifier of the run chronicle."
            }
          ]
        }
      },
      {
        "path": "/cards/{cardId}",
        "definition": {
          "entityName": "Card",
          "schema": {
            "$ref": "#/entities/Card"
          },
          "description": "Stores global card data. This collection is publicly readable, but only admin writeable.",
          "params": [
            {
              "name": "cardId",
              "description": "The unique identifier of the card."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to securely manage user data, character information, card collections, narrative contexts, and game run chronicles for the 'Poot Quest' game. Prioritizing authorization independence, data clarity, and structural segregation, the design eliminates hierarchical authorization dependencies (`get()`) and ensures robust security rules.\\n\\nAuthorization Independence is achieved through structural denormalization. For example, access to `characters` is governed by ownership; `/users/{userId}/characters/{characterId}` allows direct, secure access without needing to check parent (`/users/{userId}`) data. This same approach is applied to the other collections, creating a consistent and secure data access pattern.\\n\\nQAPs (Rules are not Filters) is supported by segregating data based on ownership (path-based authorization), and by avoiding mixing data with different access needs within the same collection. The consistent use of path-based ownership enables efficient and secure `list` operations, as rules can directly enforce access based on the `userId` parameter.\\n\\nThe design explicitly models a single, dedicated `status` field for entities, enabling clear state management and enhancing debuggability. Predictable schemas are enforced by avoiding dynamic keys and using arrays of objects with static keys instead."
  }
}
